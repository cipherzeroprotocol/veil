# SolanaVeil SDK API Reference

<div align="center">
<img src="images/api-reference-header.png" alt="API Reference Header" width="800">
</div>

## Introduction

The SolanaVeil SDK provides developers with a comprehensive set of tools to interact with the SolanaVeil privacy protocol. This document outlines the available API methods, their parameters, and usage examples.

## Installation

```bash
npm install @solanaveil/sdk
```

## Quick Start

```typescript
import { SolanaVeil, PoolType } from "@solanaveil/sdk";
import { Connection, Keypair } from "@solana/web3.js";
import { AnchorProvider, Wallet } from "@project-serum/anchor";

// Set up connection and wallet
const connection = new Connection("https://api.mainnet-beta.solana.com");
const wallet = new Wallet(Keypair.generate());
const provider = new AnchorProvider(connection, wallet, {});

// Initialize SolanaVeil
const veil = new SolanaVeil({
  provider,
  programId: "SoLV1ejPU65oFJYgPLMg7c2r9BgH9MpNDPUJTSKUJqL",
});

// Use the SDK...
```

## Core Module APIs

### SolanaVeil Class

The main entry point for interacting with the protocol.

```typescript
class SolanaVeil {
  constructor(config: SolanaVeilConfig);
  
  // Pool methods
  getPools(): Promise<Pool[]>;
  getPoolByDenomination(token: PoolToken, amount: number): Promise<Pool>;
  
  // Deposit methods
  deposit(params: DepositParams): Promise<DepositResult>;
  
  // Withdrawal methods
  generateProof(params: ProofParams): Promise<WithdrawalProof>;
  withdraw(params: WithdrawParams): Promise<WithdrawResult>;
  withdrawWithRelayer(params: RelayerWithdrawParams): Promise<WithdrawResult>;
  
  // Note management
  parseNote(note: string): NoteData;
  generateNote(params: NoteParams): string;
  
  // Compliance methods
  checkAddressRisk(address: string): Promise<RiskScore>;
}
```

### Configuration

```typescript
interface SolanaVeilConfig {
  provider: AnchorProvider;
  programId?: string;  // Defaults to mainnet program ID
  options?: {
    rpcEndpoint?: string;
    photonEndpoint?: string;
    defaultRelayer?: string;
    compliance?: ComplianceOptions;
  };
}
```

## Deposit API

### deposit()

Deposits funds into a privacy pool.

```typescript
async deposit(params: DepositParams): Promise<DepositResult>

interface DepositParams {
  amount: number;           // Amount to deposit
  token: PoolToken;         // 'SOL' or 'USDC'
  recipient?: string;       // Optional fixed recipient (reduces anonymity set)
  relayerFee?: number;      // Optional fee for relayer (for gasless withdrawals)
  note?: string;            // Optional predefined note (advanced use)
}

interface DepositResult {
  transactionId: string;    // Signature of the transaction
  note: string;             // Deposit note (KEEP THIS SECURE!)
  commitmentHash: string;   // Hash of the commitment
  nullifierHash: string;    // Hash of the nullifier (private)
}
```

#### Example

```typescript
const result = await veil.deposit({
  amount: 1,
  token: 'SOL',
});

console.log(`Transaction: ${result.transactionId}`);
console.log(`Note: ${result.note}`);
```

## Withdrawal API

### generateProof()

Generates a zero-knowledge proof for withdrawal.

```typescript
async generateProof(params: ProofParams): Promise<WithdrawalProof>

interface ProofParams {
  note: string;              // The deposit note
  recipient: string;         // Recipient address
  relayer?: string;          // Optional relayer address
  fee?: number;              // Optional relayer fee
}

interface WithdrawalProof {
  proof: string;             // Zero-knowledge proof
  publicInputs: {
    root: string;            // Merkle root
    nullifierHash: string;   // Nullifier hash
    recipient: string;       // Recipient address
    relayer: string;         // Relayer address
    fee: string;             // Relayer fee
    refund: string;          // Refund amount
  };
}
```

### withdraw()

Withdraws funds using a generated proof.

```typescript
async withdraw(params: WithdrawParams): Promise<WithdrawResult>

interface WithdrawParams {
  proof: WithdrawalProof;    // Proof generated by generateProof()
}

interface WithdrawResult {
  transactionId: string;     // Signature of the transaction
  recipient: string;         // Recipient address
  amount: number;            // Amount withdrawn
  token: PoolToken;          // Token type
  fee?: number;              // Fee paid to relayer (if applicable)
}
```

#### Example

```typescript
// Generate proof
const proof = await veil.generateProof({
  note: "solana-veil-note-1-sol-xyz...", // Your deposit note
  recipient: "8xh4ynkJpYfv38RwqGnQAN5C8jSvjpTH6iknWYA2a5Ba",
});

// Withdraw funds
const result = await veil.withdraw({ proof });

console.log(`Transaction: ${result.transactionId}`);
console.log(`Amount: ${result.amount} ${result.token}`);
```

### withdrawWithRelayer()

Withdraws funds using a relayer (for gas-less withdrawals).

```typescript
async withdrawWithRelayer(params: RelayerWithdrawParams): Promise<WithdrawResult>

interface RelayerWithdrawParams {
  note: string;              // The deposit note
  recipient: string;         // Recipient address
  relayer?: string;          // Optional specific relayer address
}
```

#### Example

```typescript
const result = await veil.withdrawWithRelayer({
  note: "solana-veil-note-1-sol-xyz...", // Your deposit note
  recipient: "8xh4ynkJpYfv38RwqGnQAN5C8jSvjpTH6iknWYA2a5Ba",
});

console.log(`Transaction: ${result.transactionId}`);
console.log(`Amount: ${result.amount} ${result.token}`);
console.log(`Fee paid: ${result.fee}`);
```

## Note Management API

### parseNote()

Parses a deposit note into its components.

```typescript
parseNote(note: string): NoteData

interface NoteData {
  amount: number;            // Deposit amount
  token: PoolToken;          // Token type
  secret: string;            // Secret component
  nullifier: string;         // Nullifier
  commitment: string;        // Commitment hash
  timestamp: number;         // Deposit timestamp
  recipient?: string;        // Fixed recipient (if specified)
}
```

### generateNote()

Generates a new deposit note.

```typescript
generateNote(params: NoteParams): string

interface NoteParams {
  amount: number;            // Deposit amount
  token: PoolToken;          // Token type
  recipient?: string;        // Optional fixed recipient
}
```

## Compliance Module APIs

### checkAddressRisk()

Checks the risk score of an address.

```typescript
async checkAddressRisk(address: string): Promise<RiskScore>

interface RiskScore {
  score: number;             // 0-100 risk score
  categories: {              // Risk categories
    aml: number;             // Anti-money laundering risk
    sanctions: number;       // Sanctions risk
    gambling: number;        // Gambling risk
    fraud: number;           // Fraud risk
  };
  addressInfo: {             // Address information
    firstSeen: number;       // First seen timestamp
    cluster: string;         // Address cluster
    tags: string[];          // Address tags
  };
}
```

## Pool Module APIs

### getPools()

Gets all available privacy pools.

```typescript
async getPools(): Promise<Pool[]>

interface Pool {
  id: string;                // Pool ID
  denomination: {            // Pool denomination
    token: PoolToken;        // Token type
    amount: number;          // Amount
  };
  stats: {                   // Pool statistics
    deposits: number;        // Number of deposits
    withdrawals: number;     // Number of withdrawals
    tvl: number;             // Total value locked
  };
  merkleRoot: string;        // Current merkle root
  addresses: {               // Pool addresses
    vault: string;           // Vault address
    config: string;          // Config address
  };
}
```

### getPoolByDenomination()

Gets a pool by token type and amount.

```typescript
async getPoolByDenomination(token: PoolToken, amount: number): Promise<Pool>
```

## Compression Module APIs

### Advanced usage only

These APIs are for advanced users who need direct access to the compression layer.

```typescript
// Merkle tree management
async getMerkleProof(commitment: string): Promise<MerkleProof>;
async getLatestRoot(): Promise<string>;

// Nullifier set management
async checkNullifier(nullifier: string): Promise<boolean>;

// Low-level compression utilities
async compressData(data: Uint8Array): Promise<Uint8Array>;
async decompressData(data: Uint8Array): Promise<Uint8Array>;
```

## Error Handling

The SDK uses a standardized error system:

```typescript
class SolanaVeilError extends Error {
  code: ErrorCode;
  details?: any;
}

enum ErrorCode {
  // General errors
  INVALID_PARAMETERS = 'invalid_parameters',
  CONNECTION_ERROR = 'connection_error',
  
  // Deposit errors
  INSUFFICIENT_FUNDS = 'insufficient_funds',
  INVALID_DENOMINATION = 'invalid_denomination',
  
  // Withdrawal errors
  INVALID_NOTE = 'invalid_note',
  ALREADY_WITHDRAWN = 'already_withdrawn',
  INVALID_PROOF = 'invalid_proof',
  PROOF_GENERATION_FAILED = 'proof_generation_failed',
  
  // Relayer errors
  RELAYER_UNAVAILABLE = 'relayer_unavailable',
  RELAYER_REJECTED = 'relayer_rejected',
  
  // Compliance errors
  COMPLIANCE_CHECK_FAILED = 'compliance_check_failed',
  HIGH_RISK_ADDRESS = 'high_risk_address',
}
```

### Example Error Handling

```typescript
import { SolanaVeil, ErrorCode } from "@solanaveil/sdk";

try {
  await veil.withdraw({ /* ... */ });
} catch (error) {
  if (error.code === ErrorCode.ALREADY_WITHDRAWN) {
    console.error("This note has already been withdrawn");
  } else if (error.code === ErrorCode.INVALID_PROOF) {
    console.error("The provided proof is invalid");
  } else {
    console.error("Unexpected error:", error);
  }
}
```

## Advanced Configuration

### Compliance Options

```typescript
interface ComplianceOptions {
  checkRecipient: boolean;      // Check recipient address risk
  maxRiskScore: number;         // Maximum allowed risk score (0-100)
  enableAmlChecks: boolean;     // Enable anti-money laundering checks
  enableSanctionsChecks: boolean; // Enable sanctions checks
  customRpcEndpoint?: string;   // Custom RPC endpoint for compliance
}
```

### Event Listeners

```typescript
// Listen for deposit events
veil.on('deposit', (data: DepositEvent) => {
  console.log(`Deposit detected: ${data.amount} ${data.token}`);
});

// Listen for withdrawal events
veil.on('withdrawal', (data: WithdrawalEvent) => {
  console.log(`Withdrawal detected: ${data.amount} ${data.token}`);
});
```

## Complete Integration Example

```typescript
import { SolanaVeil, PoolType, ErrorCode } from "@solanaveil/sdk";
import { Connection, Keypair } from "@solana/web3.js";
import { AnchorProvider, Wallet } from "@project-serum/anchor";

async function main() {
  try {
    // Set up connection and wallet
    const connection = new Connection("https://api.mainnet-beta.solana.com");
    const wallet = new Wallet(Keypair.generate());
    const provider = new AnchorProvider(connection, wallet, {});
    
    // Initialize SolanaVeil
    const veil = new SolanaVeil({
      provider,
      options: {
        compliance: {
          checkRecipient: true,
          maxRiskScore: 75,
          enableAmlChecks: true,
          enableSanctionsChecks: true,
        }
      }
    });
    
    // Get available pools
    const pools = await veil.getPools();
    console.log(`Available pools: ${pools.length}`);
    
    // Deposit funds
    const depositResult = await veil.deposit({
      amount: 1,
      token: 'SOL',
    });
    
    console.log(`Deposit successful! Note: ${depositResult.note}`);
    
    // Store the note securely (in real applications)
    // ...
    
    // Later, withdraw the funds
    const recipientAddress = "8xh4ynkJpYfv38RwqGnQAN5C8jSvjpTH6iknWYA2a5Ba";
    
    // Generate proof
    const proof = await veil.generateProof({
      note: depositResult.note,
      recipient: recipientAddress,
    });
    
    // Withdraw funds
    const withdrawResult = await veil.withdraw({
      proof,
    });
    
    console.log(`Withdrawal successful! Transaction: ${withdrawResult.transactionId}`);
  } catch (error) {
    console.error(`Error: ${error.message}`);
    if (error.code) {
      console.error(`Error code: ${error.code}`);
    }
  }
}

main();
```

---

<div align="center">
<p><strong>SolanaVeil</strong> • Privacy-Preserving Mixer with ZK Compression</p>
</div>